<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Follow-up Sender</title>
<style>
  :root { --pad:14px; }
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;max-width:900px}
  h1{margin:0 0 12px}
  .card{border:1px solid #ddd;border-radius:12px;padding:var(--pad);margin:12px 0}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,textarea{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ccc;border-radius:10px}
  .row{display:flex;gap:12px} .row>div{flex:1}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  button,a.btn{border:1px solid #ccc;border-radius:999px;padding:10px 14px;text-decoration:none;cursor:pointer;background:#fff}
  .pill{font-size:12px;background:#f4f4f4;border-radius:999px;padding:4px 8px;margin-left:6px}
  #pos{opacity:.7;margin-top:8px}
  .tiny{font-size:12px;opacity:.8}
</style>
</head>
<body>
<h1>Follow-up Sender <span class="pill">v1.3</span></h1>

<div class="card">
  <label>Paste customer blocks (raw from Salesforce; line breaks optional):</label>
  <textarea id="blocks" rows="9" placeholder="LEAD - Name - POSTCODE - (Product) £Amount OfferCode DD/MM/YYYY 07xxxxxxxxx email@example.com https://..."></textarea>
  <div class="btns">
    <button onclick="parseAll()">Parse</button>
    <button onclick="example()">Load Example</button>
  </div>
  <div class="tiny">Tip: multiple leads supported. If there are no blank lines, the parser splits at each https:// link.</div>
</div>

<div class="card">
  <strong>Pushcut (work email via Automation Server)</strong>
  <label>Pushcut Webhook URL</label>
  <input id="pcurl" placeholder="https://api.pushcut.io/v1/YOUR/WEBHOOK" oninput="savePC()" />
  <div class="tiny">Create a Pushcut Automation Server webhook that runs a Shortcut on your office device to send the email. This app POSTs JSON {to,subject,body} to that URL.</div>
</div>

<div id="work" class="card" style="display:none">
  <div class="row">
    <div><label>Lead ID</label><input id="lead"></div>
    <div><label>Name</label><input id="name"></div>
  </div>
  <div class="row">
    <div><label>Postcode</label><input id="pc"></div>
    <div><label>Product Code</label><input id="prod"></div>
  </div>
  <div class="row">
    <div><label>Offer Code</label><input id="offer"></div>
    <div><label>Amount</label><input id="amount"></div>
  </div>
  <div class="row">
    <div><label>Date</label><input id="date" inputmode="numeric" placeholder="DD/MM/YYYY"></div>
    <div><label>Email</label><input id="email" type="email"></div>
  </div>
  <div class="row">
    <div><label>Phone 1</label><input id="phone1" inputmode="tel"></div>
    <div><label>Phone 2</label><input id="phone2" inputmode="tel"></div>
  </div>
  <label>Quote Link</label><input id="link">

  <label>SMS Template</label>
  <textarea id="sms" rows="12">Good morning it’s Martin Bibb from British Gas.

I recently came and visited you and provided you with a new boiler quotation. I’m just following up some of my quotations and I’ve noticed that the Office I’ve offered you an extra £150 discount due to having spare engine engineer installation capacity at the moment.

I just wanted to check you have seen the email with this discount attached to it, if this is something you are interested in accepting then please follow the email with the discount code.

If you’re interested in accepting the extra £150 off and haven’t seen the email, please let me know and I’ll guide you through the next stages.

Quote link: {{link}}

Have a great day.</textarea>

  <label>Email Subject</label>
  <input id="subj" value="Your boiler quote & discount ({{offer}} / {{amount}})">

  <label>Email Body</label>
  <textarea id="body" rows="10">Hello {{name}},

I recently visited to provide your boiler quotation. We currently have spare engineer installation capacity, so the office has authorised an extra discount for you.

• Offer code: {{offer}} ({{amount}})
• Quote link: {{link}}
• Lead: {{lead}} • Postcode: {{pc}} • Product: {{prod}}
• Proposed date: {{date}}

If you can’t find the discount email, reply and I’ll guide you through the next steps.

Best regards,
Martin</textarea>

  <div class="btns">
    <button onclick="sendSMS()">Send SMS</button>
    <button onclick="sendEmail()">Open Mail</button>
    <button onclick="sendViaPushcut()">Send Email via Pushcut</button>
    <button onclick="copyAll()">Copy both messages</button>
    <button onclick="prev()">◀︎ Prev</button>
    <button onclick="next()">Next ▶︎</button>
  </div>
  <div id="pos"></div>
</div>

<script>
let items=[], i=0;

function example(){
  document.getElementById('blocks').value =
`12345678 - Alex Example - AB1 2CD - (C3_01_155) £175.00 ABC123 18/11/2025 07123456789 alex@example.com https://example.com/lead/abcdef?cid=test

87654321 - Jamie Sample - ZZ9 9ZZ - (C4_02_200) £90.00 Z9Y8X7 25/11/2025 07000111222 jamie@example.com https://example.com/lead/xyz987?cid=test`;
  const saved = localStorage.getItem('pcurl')||''; document.getElementById('pcurl').value=saved;
}

function savePC(){ localStorage.setItem('pcurl', document.getElementById('pcurl').value.trim()); }

function parseAll(){
  const saved = localStorage.getItem('pcurl')||''; document.getElementById('pcurl').value=saved;
  const raw0 = document.getElementById('blocks').value;
  if(!raw0 || !raw0.trim()){ alert('Paste one or more customer blocks first.'); return; }
  const raw = raw0.replace(/\r/g,'');
  let blocks = raw.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);
  if(blocks.length===1){
    // If no blank lines, split on each http(s) occurrence
    blocks = raw.split(/(?=https?:\/\/)/i).map(s=>s.trim()).filter(Boolean);
  }
  items = blocks.map(parseBlockSmart).filter(Boolean);
  if(!items.length){ alert('Could not parse any valid blocks.'); return; }
  i=0; document.getElementById('work').style.display='block'; load();
}

function parseBlockSmart(text){
  // Normalise NBSPs/tabs to spaces then collapse
  const t = text.replace(/[\u00A0\t]+/g,' ').replace(/\s+/g,' ').trim();

  // Lead - Name - Postcode - (Product)
  let lead='', name='', pc='', prod='';
  const m1 = t.match(/^(\d+)\s*-\s*([^-]+?)\s*-\s*([A-Z0-9 ]{4,8})\s*-\s*\(([^)]+)\)/i);
  if(m1){ lead=m1[1].trim(); name=m1[2].trim(); pc=m1[3].trim(); prod=m1[4].trim(); }

  // Amount: first currency-looking token
  const amount = (t.match(/(£\s?\d[\d,]*\.?\d{0,2})/i)||['',''])[1];

  // Offer: 5–12 alphanumerics not part of URL params
  const offer  = (t.match(/\b(?!cid=)[A-Z0-9]{5,12}\b(?![^?]*=)/i)||['',''])[1];

  // Date
  const date   = (t.match(/\b\d{2}\/\d{2}\/\d{4}\b/)||['',''])[1];

  // Phones (up to two)
  const phones = Array.from(t.matchAll(/\b(?:\+?44|0)\d{9,10}\b/g)).map(m=>m[0]).slice(0,2);
  const phone1 = phones[0]||'', phone2 = phones[1]||'';

  // Email
  const email  = (t.match(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i)||['',''])[1];

  // Link: use the LAST https URL in the text (quotes often end with a long link)
  const urls = Array.from(t.matchAll(/https?:\/\/\S+/ig)).map(m=>m[0].replace(/[).,;]+$/,''));
  const link = urls.length ? urls[urls.length-1] : '';

  // Fallback: strict line-based if needed
  if(!(lead && name && pc && prod)){
    const lines = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    if(lines.length>=1){
      const m = lines[0].match(/^\s*([^-\n]+)\s*-\s*([^-\n]+)\s*-\s*([A-Z0-9 ]+)\s*-\s*\(([^)]+)\)\s*$/i);
      if(m){ lead=m[1].trim(); name=m[2].trim(); pc=m[3].trim(); prod=m[4].trim(); }
    }
  }

  return { lead, name, pc, prod, amount, offer, date, phone1, phone2, email, link };
}

function load(){
  const d = items[i];
  set('lead', d.lead); set('name', d.name); set('pc', d.pc); set('prod', d.prod);
  set('amount', d.amount); set('offer', d.offer); set('date', d.date);
  set('phone1', d.phone1); set('phone2', d.phone2); set('email', d.email); set('link', d.link);
  document.getElementById('pos').textContent = `Customer ${i+1} of ${items.length}`;
}

function set(id,v){ document.getElementById(id).value = v ?? '' }
function val(id){ return document.getElementById(id).value.trim() }

function getData(){
  return {
    lead: val('lead'), name: val('name'), pc: val('pc'), prod: val('prod'),
    amount: val('amount'), offer: val('offer'), date: val('date'),
    phone: val('phone1') || val('phone2'),
    email: val('email'), link: val('link'),
    smsTpl: document.getElementById('sms').value,
    subjTpl: document.getElementById('subj').value,
    bodyTpl: document.getElementById('body').value
  };
}

function fill(t,d){
  return t.replaceAll('{{lead}}',d.lead).replaceAll('{{name}}',d.name)
    .replaceAll('{{pc}}',d.pc).replaceAll('{{prod}}',d.prod)
    .replaceAll('{{amount}}',d.amount).replaceAll('{{offer}}',d.offer)
    .replaceAll('{{date}}',d.date).replaceAll('{{link}}',d.link);
}

function sendSMS(){
  const d = getData();
  const body = fill(d.smsTpl, d);
  const number = (d.phone || '').replace(/\s+/g,'');
  const base = number ? `sms:${encodeURIComponent(number)}` : 'sms:';
  location.href = `${base}&body=${encodeURIComponent(body)}`;
}

function sendEmail(){
  const d = getData();
  const to = d.email ? encodeURIComponent(d.email) : '';
  const subj = encodeURIComponent(fill(d.subjTpl, d));
  const body = encodeURIComponent(fill(d.bodyTpl, d));
  location.href = `mailto:${to}?subject=${subj}&body=${body}`;
}

async function sendViaPushcut(){
  const url = (document.getElementById('pcurl').value||'').trim();
  if(!url){ alert('Add your Pushcut webhook URL first.'); return; }
  const d = getData();
  const payload = {
    to: d.email,
    subject: fill(d.subjTpl,d),
    body: fill(d.bodyTpl,d),
    meta: { lead:d.lead, name:d.name, offer:d.offer, amount:d.amount, link:d.link }
  };
  try{
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error(String(res.status));
    alert('Sent to Pushcut webhook.');
  }catch(e){
    alert('Pushcut webhook failed. If blocked by CORS, send via a small Cloudflare Worker proxy.');
  }
}

async function copyAll(){
  const d = getData();
  const sms = 'SMS:\n' + fill(d.smsTpl, d) + '\n\n';
  const email = 'EMAIL SUBJECT:\n' + fill(d.subjTpl,d) + '\n\nEMAIL BODY:\n' + fill(d.bodyTpl,d);
  try { await navigator.clipboard.writeText(sms + email); alert('Copied SMS + Email to clipboard.'); }
  catch { alert('Copy failed (browser security).'); }
}

function next(){ if(i < items.length-1){ i++; load(); } }
function prev(){ if(i > 0){ i--; load(); } }

// Restore Pushcut URL on load
document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('pcurl')||''; document.getElementById('pcurl').value=saved;
});
</script>
</body>
</html>
