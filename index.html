<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QFU Messaging • v2.3 (Markdown-safe)</title>
<style>
  :root { --pad:14px; }
  html,body{background:#f6f7fb}
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;max-width:980px}
  h1{margin:0 0 12px}
  .card{border:1px solid #ddd;border-radius:12px;padding:var(--pad);margin:12px 0;background:#fff}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,textarea{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ccc;border-radius:10px;background:#fff}
  .row{display:flex;gap:12px;flex-wrap:wrap} .row>div{flex:1;min-width:240px}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  button{border:1px solid #ccc;border-radius:999px;padding:10px 14px;background:#fff;cursor:pointer}
  .pill{font-size:12px;background:#eef;border-radius:999px;padding:4px 8px;margin-left:6px}
  pre.preview{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:10px;padding:12px;margin:6px 0}
  table{border-collapse:collapse;width:100%} th,td{border:1px solid #eee;padding:8px;text-align:left}
  th{background:#fafafa}
  .tiny{font-size:12px;opacity:.8}
  #pos{opacity:.7;margin-top:8px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<h1>QFU Messaging <span class="pill">v2.3</span></h1>

<div class="card">
  <label>Paste data (raw from Salesforce or the Markdown version from your Shortcut):</label>
  <textarea id="blocks" rows="14" class="mono" placeholder="[5043… - Name - BHxx xxx - (C3_01_155)](…)
£150.00
22HSP6
18/11/2025
[077…](tel:077…)
[+447…](tel:+447…)
[email@…](mailto:email@…)
<https://…>
-
20/07/2022
Appointed
LO-xxxxx

[5043… - Next Name - …](…)"></textarea>
  <div class="btns">
    <button onclick="parseAll()">Parse</button>
    <button onclick="example()">Load Example</button>
  </div>
  <div class="tiny">Parser auto-strips Markdown wrappers and fancy dashes before parsing.</div>
</div>

<div id="work" class="card" style="display:none">
  <div class="row">
    <div><label>Lead</label><input id="lead"></div>
    <div><label>Name</label><input id="name"></div>
    <div><label>Postcode</label><input id="pc"></div>
    <div><label>Area</label><input id="area"></div>
  </div>
  <div class="row">
    <div><label>Offer Amount</label><input id="amount" placeholder="£150.00"></div>
    <div><label>Offer Code</label><input id="offer" placeholder="22HSP6"></div>
    <div><label>Offer Ends</label><input id="offerEnds" placeholder="DD/MM/YYYY"></div>
  </div>
  <div class="row">
    <div><label>Mobile</label><input id="phone1" inputmode="tel"></div>
    <div><label>Other Number</label><input id="phone2" inputmode="tel"></div>
    <div><label>Email</label><input id="email" type="email"></div>
  </div>
  <label>Quote Link</label><input id="link" placeholder="https://…">

  <div class="row">
    <div><label>HSA Followed Up</label><input id="hsa"></div>
    <div><label>Offer Created</label><input id="created" placeholder="DD/MM/YYYY"></div>
    <div><label>Stage</label><input id="stage"></div>
    <div><label>Offer Name</label><input id="offerName"></div>
  </div>

  <div class="row">
    <div>
      <label>SMS Template</label>
      <textarea id="smsTpl" rows="11" class="mono">Good morning it’s Martin Bibb from British Gas.

I recently visited and provided you with a boiler quotation. I’m following up as the office has offered you an extra {{amount}} discount (code {{offer}}) due to spare engineer capacity.

Offer ends: {{offerEnds}}.

If you’ve seen the email with this discount, great — if not, let me know and I’ll guide you through the next steps.

Quote link: {{link}}

Have a great day.</textarea>
    </div>
    <div>
      <label>Email Subject Template</label>
      <input id="subjTpl" value="Your boiler quote & discount ({{offer}} / {{amount}}) – ends {{offerEnds}}">
      <label>Email Body Template</label>
      <textarea id="bodyTpl" rows="12" class="mono">Hello {{name}},

I recently visited to provide your boiler quotation for your home. We currently have spare engineer capacity, so the office has authorised an extra discount for you.

• Offer code: {{offer}} ({{amount}})
• Offer ends: {{offerEnds}}
• Quote link: {{link}}

If you can’t find the discount email, reply and I’ll guide you through the next steps.

Best regards,</textarea>
    </div>
  </div>

  <h3>Preview (filled)</h3>
  <div class="row">
    <div>
      <strong>SMS</strong>
      <pre id="smsPreview" class="preview"></pre>
    </div>
    <div>
      <strong>Email</strong>
      <div class="tiny">Subject</div>
      <pre id="subjPreview" class="preview"></pre>
      <div class="tiny">Body</div>
      <pre id="bodyPreview" class="preview"></pre>
    </div>
  </div>

  <div class="btns">
    <button onclick="sendSMS()">Send SMS</button>
    <button onclick="openMail()">Open Mail</button>
    <button onclick="copyBoth()">Copy both messages</button>
    <button onclick="prev()">◀︎ Prev</button>
    <button onclick="next()">Next ▶︎</button>
    <button onclick="previewAll()">Batch Preview</button>
  </div>
  <div id="pos"></div>
</div>

<div id="batch" class="card" style="display:none">
  <h3>Batch Preview (all records)</h3>
  <div style="overflow:auto;max-height:420px">
    <table id="batchTable"><thead>
      <tr>
        <th>#</th><th>Lead</th><th>Name</th><th>PC</th><th>Area</th>
        <th>£</th><th>Code</th><th>Ends</th><th>Email</th><th>Mobile</th><th>Link</th>
      </tr>
    </thead><tbody></tbody></table>
  </div>
</div>

<script>
/* ========= Normalise & Markdown helpers ========= */
function basePre(s){
  return (s||'')
    .replace(/\r/g,'')
    .replace(/\u00A0/g,' ')
    .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g,'-');
}
function baseNorm(s){ return basePre(s).trim(); }
function baseLines(s){ return basePre(s).split('\n'); }

const emailPlainRe  = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/ig;
const urlPlainRe    = /https?:\/\/[^\s)>,]+/ig;
const mobilePlainRe = /\b(?:\+?\s*44\s*7\d{2}|0\s*7\d{2})\s*\d{3}\s*\d{4}\b/ig;

function markdownify(text){
  const lines = baseLines(text);
  const out = [];
  for(let i=0;i<lines.length;i++){
    let ln = lines[i];
    if(!HEADER_RE.test(ln)){
      ln = ln.replace(urlPlainRe, (m)=>`<${m}>`);
      ln = ln.replace(emailPlainRe, (m)=>`[${m}](mailto:${m})`);
      ln = ln.replace(mobilePlainRe, (m)=>{
        const tel = m.replace(/\s+/g,'');
        return `[${m}](tel:${tel})`;
      });
    }
    out.push(ln);
  }
  return out.join('\n');
}

function stripMarkdownLinks(s){
  return (s||'')
    // [label](mailto:…|tel:…|http…)
    .replace(/\[([^\]]+)\]\((?:mailto:|tel:|https?:\/\/)[^)]+\)/gi,'$1')
    // <https://…>
    .replace(/<\s*(https?:\/\/[^>\s]+)\s*>/gi,'$1');
}

function pre(s){ return stripMarkdownLinks(basePre(s)); }
function _norm(s){ return pre(s).trim(); }
function _lines(s){ return pre(s).split('\n'); }

/* ========= Regexes ========= */
const HEADER_RE = /^\s*(\d+)\s*[-–—]\s*(.+?)\s*[-–—]\s*([A-Z0-9 ]{3,8})\s*[-–—]\s*\(([^)]+)\)\s*$/i;
const emailRe  = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;
const moneyRe  = /(£\s?\d[\d,]*\.?\d{0,2})/i;
const dateRe   = /\b\d{2}\/\d{2}\/\d{4}\b/;
const urlRe    = /https?:\/\/[^\s)>,]+/i;
const mobileRe = /\b(?:\+?\s*44\s*7\d{2}|0\s*7\d{2})\s*\d{3}\s*\d{4}\b/ig;

/* ========= State ========= */
let items=[], idx=0;

/* ========= Example ========= */
function example(){
  document.getElementById('blocks').value =
`[50430409 - Kirsty Rolt - BH23 4LH - (C3_01_155)](https://homeinstallation.my.salesforce.com/006Tw00000JaxY5)
£150.00
22HSP6
18/11/2025
[07714869715](tel:07714869715)
[+447714869715](tel:+447714869715)
[kirstyrolt@yahoo.co.uk](mailto:kirstyrolt@yahoo.co.uk)
<https://www.mybritishgashomeinstallation.co.uk/lead/dd99df81eb34b18b18fbdf5b38341c873543528d2bc15723c608dc14f1836b413b57e40e5fbe76eb61eca122872b6613>
-
20/07/2022
Appointed
LO-526459

[50433921 - Marian Barbu - BH1 1HX - (C3_01_155)](https://homeinstallation.my.salesforce.com/006Tw00000JgzXB)
£150.00
22WSC4
18/11/2025
[07597604176](tel:07597604176)
[07597604176](tel:07597604176)
[marian.barbu33@yahoo.ro](mailto:marian.barbu33@yahoo.ro)
<https://www.mybritishgashomeinstallation.co.uk/lead/f470d2e598ca41d32b8a4ca0acb96b44647e8e502f69988fd4591959827e0c2998f37a6bb47fd3327863b586ca19708d?cid=oem_HSA_Web>
-
20/07/2022
Appointed
LO-527152`;
}

/* ========= Parse entry ========= */
function parseAll(){
  const ta = document.getElementById('blocks');
  const raw0 = ta ? ta.value : '';
  if(!baseNorm(raw0)){ alert('Paste data first.'); return; }

  const md = markdownify(raw0);
  if(ta) ta.value = md;

  const clean = stripMarkdownLinks(basePre(md));

  items = parseBlocks(clean);
  if(!items.length){ alert('Could not parse any records.'); return; }
  idx=0;
  document.getElementById('work').style.display='block';
  loadRecord();
  buildBatchTable();
}

/* ========= Core parser (header split + positional fields) ========= */
function parseBlocks(text){
  const lines = _lines(text);
  const starts=[];
  for(let i=0;i<lines.length;i++){ if(HEADER_RE.test(lines[i])) starts.push(i); }
  // fallback: blank-line blocks if no headers
  if(!starts.length){
    const chunks = text.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);
    return chunks.map(parseOne).filter(validRec);
  }
  const blocks=[];
  for(let j=0;j<starts.length;j++){
    const start=starts[j];
    const end=(j<starts.length-1)?starts[j+1]:lines.length;
    blocks.push(lines.slice(start,end).join('\n').trim());
  }
  return blocks.map(parseOne).filter(validRec);
}
function validRec(r){ return r && (r.lead || r.email || r.link); }

function parseOne(block){
  const ls = _lines(block).map(s=>s.trim()).filter(Boolean);
  const hIdx = ls.findIndex(ln=>HEADER_RE.test(ln));
  if(hIdx<0) return {};

  const hm = ls[hIdx].match(HEADER_RE);
  const lead = hm[1].trim(), name = hm[2].trim(), pc = hm[3].trim(), area = hm[4].trim();

  // Next lines in order; allow blanks / '-' lines (skip them)
  const tail = ls.slice(hIdx+1).filter(x => x && x !== '-');

  // Positional mapping with validation/fallbacks
  const amount    = pickAmount(tail[0]);
  const offer     = pickOffer(tail[1]);
  const offerEnds = pickDate(tail[2]);

  const phone1    = pickPhone(tail[3]);
  const phone2    = pickPhone(tail[4]);

  const email     = pickEmail(tail[5]) || findLastEmail(tail);
  const link      = pickUrl(tail[6])   || findFirstUrl(tail);

  const hsa       = tail[7] || '';
  const created   = pickDate(tail[8]) || '';
  const stage     = tail[9] || '';
  const offerName = tail[10] || '';

  return { lead,name,pc,area, amount,offer,offerEnds, phone1,phone2, email,link, hsa,created,stage,offerName };
}

/* ========= Pickers / validators ========= */
function pickAmount(s){ const m=(s||'').match(moneyRe); return m?m[1]: (s||''); }
function pickOffer(s){
  const v=(s||'').trim().toUpperCase();
  if(/^[A-Z0-9]{5,12}$/.test(v) && /[A-Z]/.test(v) && /\d/.test(v)) return v;
  return v;
}
function pickDate(s){ const m=(s||'').match(dateRe); return m?m[0]: (s||''); }
function pickPhone(s){
  const raw=(s||'').toString().trim();
  if(!raw || raw==='-') return '';
  const m = raw.match(mobileRe);
  if(!m) return '';
  return m[0].replace(/\s+/g,'').replace(/^0/,'+44').replace(/^\+?44/,'+44');
}
function pickEmail(s){ const m=(s||'').match(emailRe); return m?m[0].toLowerCase():''; }
function pickUrl(s){ const m=(s||'').match(urlRe); return m? m[0].replace(/[).,;]+$/,'') : ''; }

function findLastEmail(arr){
  for(let i=arr.length-1;i>=0;i--){ const m=(arr[i]||'').match(emailRe); if(m) return m[0].toLowerCase(); }
  return '';
}
function findFirstUrl(arr){
  for(const ln of arr){ const m=(ln||'').match(urlRe); if(m) return m[0].replace(/[).,;]+$/,''); }
  return '';
}

/* ========= UI / Preview ========= */
function setVal(id,v){ document.getElementById(id).value = v ?? ''; }
function getVal(id){ return document.getElementById(id).value.trim(); }
function current(){
  return {
    lead:getVal('lead'), name:getVal('name'), pc:getVal('pc'), area:getVal('area'),
    amount:getVal('amount'), offer:getVal('offer'), offerEnds:getVal('offerEnds'),
    phone:getVal('phone1') || getVal('phone2'),
    email:getVal('email'), link:getVal('link'),
    hsa:getVal('hsa'), created:getVal('created'), stage:getVal('stage'), offerName:getVal('offerName')
  };
}
function fillTpl(tpl, rec){
  return (tpl||'')
    .replace(/{{\s*lead\s*}}/gi, rec.lead||'')
    .replace(/{{\s*name\s*}}/gi, rec.name||'')
    .replace(/{{\s*pc\s*}}/gi, rec.pc||'')
    .replace(/{{\s*area\s*}}/gi, rec.area||'')
    .replace(/{{\s*amount\s*}}/gi, rec.amount||'')
    .replace(/{{\s*offer\s*}}/gi, rec.offer||'')
    .replace(/{{\s*offerEnds\s*}}/gi, rec.offerEnds||'')
    .replace(/{{\s*date\s*}}/gi, rec.created||'')
    .replace(/{{\s*link\s*}}/gi, rec.link||'')
    .replace(/{{\s*email\s*}}/gi, rec.email||'')
    .replace(/{{\s*stage\s*}}/gi, rec.stage||'')
    .replace(/{{\s*offerName\s*}}/gi, rec.offerName||'');
}
function refreshPreview(){
  const rec = current();
  const sms  = fillTpl(getVal('smsTpl'), rec);
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  document.getElementById('smsPreview').textContent  = sms;
  document.getElementById('subjPreview').textContent = subj;
  document.getElementById('bodyPreview').textContent = body;
  document.getElementById('pos').textContent = `Record ${idx+1} of ${items.length}`;
}
function loadRecord(){
  const d = items[idx];
  setVal('lead', d.lead); setVal('name', d.name); setVal('pc', d.pc); setVal('area', d.area);
  setVal('amount', d.amount); setVal('offer', d.offer); setVal('offerEnds', d.offerEnds);
  setVal('phone1', d.phone1 || ''); setVal('phone2', d.phone2 || '');
  setVal('email', d.email); setVal('link', d.link);
  setVal('hsa', d.hsa||''); setVal('created', d.created||''); setVal('stage', d.stage||''); setVal('offerName', d.offerName||'');
  refreshPreview();
}
function next(){ if(idx < items.length-1){ idx++; loadRecord(); } }
function prev(){ if(idx > 0){ idx--; loadRecord(); } }

function buildBatchTable(){
  const tbody = document.querySelector('#batchTable tbody');
  tbody.innerHTML = '';
  items.forEach((d, i) => {
    const tr = document.createElement('tr');
    const phone = d.phone1 || d.phone2 || '';
    tr.innerHTML = `<td>${i+1}</td><td>${d.lead||''}</td><td>${d.name||''}</td><td>${d.pc||''}</td><td>${d.area||''}</td>
                    <td>${d.amount||''}</td><td>${d.offer||''}</td><td>${d.offerEnds||''}</td>
                    <td>${d.email||''}</td><td>${phone}</td><td>${d.link?'<a href="'+d.link+'" target="_blank">link</a>':''}</td>`;
    tbody.appendChild(tr);
  });
}
function previewAll(){ buildBatchTable(); document.getElementById('batch').style.display = 'block'; }

/* ========= Actions ========= */
function sendSMS(){
  const rec = current();
  const msg = fillTpl(getVal('smsTpl'), rec);
  const number = (rec.phone||'').replace(/\s+/g,'');
  const base = number ? `sms:${encodeURIComponent(number)}` : 'sms:';
  location.href = `${base}&body=${encodeURIComponent(msg)}`;
}
function openMail(){
  const rec = current();
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  const to   = rec.email ? encodeURIComponent(rec.email) : '';
  location.href = `mailto:${to}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
}
async function copyBoth(){
  const rec = current();
  const sms  = fillTpl(getVal('smsTpl'), rec);
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  const txt = `SMS:\n${sms}\n\nEMAIL SUBJECT:\n${subj}\n\nEMAIL BODY:\n${body}`;
  try{ await navigator.clipboard.writeText(txt); alert('Copied SMS + Email to clipboard.'); }catch{ alert('Copy failed (browser)'); }
}

/* Live preview on edit */
['lead','name','pc','area','amount','offer','offerEnds','phone1','phone2','email','link','hsa','created','stage','offerName','smsTpl','subjTpl','bodyTpl']
  .forEach(id => document.getElementById(id).addEventListener('input', refreshPreview));
</script>
</body>
</html>
