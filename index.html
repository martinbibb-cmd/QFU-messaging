<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Follow-up Sender</title>
<style>
  :root { --pad:14px; }
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;max-width:900px}
  h1{margin:0 0 12px}
  .card{border:1px solid #ddd;border-radius:12px;padding:var(--pad);margin:12px 0}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,textarea{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ccc;border-radius:10px}
  .row{display:flex;gap:12px} .row>div{flex:1}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  button,a.btn{border:1px solid #ccc;border-radius:999px;padding:10px 14px;text-decoration:none;cursor:pointer;background:#fff}
  .pill{font-size:12px;background:#f4f4f4;border-radius:999px;padding:4px 8px;margin-left:6px}
  #pos{opacity:.7;margin-top:8px}
  .tiny{font-size:12px;opacity:.8}
</style>
</head>
<body>
<h1>Follow-up Sender <span class="pill">v1.3</span></h1>

<div class="card">
  <label>Paste customer blocks (raw from Salesforce; line breaks optional):</label>
  <textarea id="blocks" rows="9" placeholder="LEAD - Name - POSTCODE - (Product) £Amount OfferCode DD/MM/YYYY 07xxxxxxxxx email@example.com https://..."></textarea>
  <div class="btns">
    <button onclick="parseAll()">Parse</button>
    <button onclick="example()">Load Example</button>
  </div>
  <div class="tiny">Tip: multiple leads supported. If there are no blank lines, the parser splits at each https:// link.</div>
</div>

<div class="card">
  <strong>Pushcut (work email via Automation Server)</strong>
  <label>Pushcut Webhook URL</label>
  <input id="pcurl" value="https://api.pushcut.io/cieTVWDg1mtNM4SOt20_N/notifications/Send%20work%20email" readonly />
  <div class="tiny">This app POSTs JSON {to,subject,body} to your Pushcut Automation Server using the webhook above.</div>
</div>

<div id="work" class="card" style="display:none">
  <div class="row">
    <div><label>Lead ID</label><input id="lead"></div>
    <div><label>Name</label><input id="name"></div>
  </div>
  <label>Sender Name</label><input id="sender" value="Martin Bibb">
  <div class="row">
    <div><label>Postcode</label><input id="pc"></div>
    <div><label>Product Code</label><input id="prod"></div>
  </div>
  <div class="row">
    <div><label>Offer Code</label><input id="offer"></div>
    <div><label>Amount</label><input id="amount"></div>
  </div>
  <div class="row">
    <div><label>Date</label><input id="date" inputmode="numeric" placeholder="DD/MM/YYYY"></div>
    <div><label>Email</label><input id="email" type="email"></div>
  </div>
  <div class="row">
    <div><label>Phone 1</label><input id="phone1" inputmode="tel"></div>
    <div><label>Phone 2</label><input id="phone2" inputmode="tel"></div>
  </div>
  <label>Quote Link</label><input id="link">

  <label>SMS Template</label>
  <textarea id="sms" rows="12">{{greeting}} it’s {{sender}} from British Gas.

I recently came and visited you and provided you with a new boiler quotation. I’m just following up some of my quotations and I’ve noticed that the office has offered you an extra {{amount}} discount due to having spare engineer installation capacity at the moment.

I just wanted to check you have seen the email with this discount attached to it, if this is something you are interested in accepting then please follow the email with the discount code.

If you’re interested in accepting the extra {{amount}} off and haven’t seen the email, please let me know and I’ll guide you through the next stages.

Offer code {{offer}}
Quote link: {{link}}

Have a great day.

All my best

{{sender}}</textarea>

  <label>Email Subject</label>
  <input id="subj" value="Your boiler quote & discount ({{offer}} / {{amount}})">

  <label>Email Body</label>
  <textarea id="body" rows="10">{{greeting}} {{name}},

I recently visited to provide your boiler quotation. We currently have spare engineer installation capacity, so the office has authorised an extra discount for you.

• Offer code: {{offer}} ({{amount}})
• Quote link: {{link}}
• Lead: {{lead}} • Postcode: {{pc}} • Product: {{prod}}
• Proposed date: {{date}}

If you can’t find the discount email, reply and I’ll guide you through the next steps.

Best regards,
{{sender}}</textarea>

  <div class="btns">
    <button onclick="sendSMS()">Send SMS</button>
    <button onclick="sendEmail()">Open Mail</button>
    <button onclick="sendViaPushcut()">Send Email via Pushcut</button>
    <button onclick="copyAll()">Copy both messages</button>
    <button onclick="prev()">◀︎ Prev</button>
    <button onclick="next()">Next ▶︎</button>
  </div>
  <div id="pos"></div>
</div>

<script>
const PUSH_CUT_WEBHOOK_URL = 'https://api.pushcut.io/cieTVWDg1mtNM4SOt20_N/notifications/Send%20work%20email';
let items=[], i=0;

function _norm(s){ return (s||'').replace(/\r/g,'').replace(/[\u00A0\t]+/g,' ').trim(); }

function getGreeting(){
  const hour = new Date().getHours();
  return hour < 12 ? 'Good morning' : 'Good afternoon';
}

function example(){
  document.getElementById('blocks').value =
`12345678 - Alex Example - AB1 2CD - (C3_01_155) £175.00 ABC123 18/11/2025 07123456789 alex@example.com https://example.com/lead/abcdef?cid=test

87654321 - Jamie Sample - ZZ9 9ZZ - (C4_02_200) £90.00 Z9Y8X7 25/11/2025 07000111222 jamie@example.com https://example.com/lead/xyz987?cid=test`;
}

function parseAll(){
  const raw0 = document.getElementById('blocks').value;
  if(!raw0 || !raw0.trim()){ alert('Paste one or more customer blocks first.'); return; }
  const raw = raw0.replace(/\r/g,'');

  // 1) Preferred: explicit blank-line blocks
  let blocks = raw.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);

  // 2) Robust: split by HEADER LINES like "5043… - Name - PC - (Product)"
  // This handles trailing lines after URLs ( '-', dates, 'Appointed', 'LO-xxxxx', etc.)
  if(blocks.length <= 1){
    const lines = raw.split('\n');
    const headerRe = /^\s*\d+\s*-\s*[^-]+?-\s*[A-Z0-9 ]{3,8}\s*-\s*\([^)]+\)\s*$/i;
    const headerIdx = [];
    for(let idx=0; idx<lines.length; idx++){
      if(headerRe.test(lines[idx])) headerIdx.push(idx);
    }
    if(headerIdx.length){
      const chunks = [];
      for(let j=0; j<headerIdx.length; j++){
        const start = headerIdx[j];
        const end   = (j < headerIdx.length-1) ? headerIdx[j+1] : lines.length;
        chunks.push(lines.slice(start, end).join('\n').trim());
      }
      blocks = chunks.filter(Boolean);
    }
  }

  // 3) Fallback: treat whole paste as one block
  if(!blocks.length) blocks = [raw.trim()];

  items = blocks.map(parseBlockSmart).filter(Boolean);
  if(!items.length){ alert('Could not parse any valid blocks.'); return; }
  i = 0;
  document.getElementById('work').style.display = 'block';
  load();
}

function parseBlockSmart(text){
  const t = _norm(text);

  // HEADER anywhere in the chunk
  let lead='', name='', pc='', prod='';
  const m1 = t.match(/(\d+)\s*-\s*([^-]+?)\s*-\s*([A-Z0-9 ]{3,8})\s*-\s*\(([^)]+)\)/i);
  if(m1){ lead=_norm(m1[1]); name=_norm(m1[2]); pc=_norm(m1[3]); prod=_norm(m1[4]); }

  // Amount £… (first)
  const amount = (t.match(/(£\s?\d[\d,]*\.?\d{0,2})/i)||['',''])[1] || '';

  // Offer 5–12 alphanumerics not from query params
  const offer  = (t.match(/\b(?!cid=)[A-Z0-9]{5,12}\b(?![^?]*=)/i)||['',''])[1] || '';

  // Date DD/MM/YYYY (take the first)
  const date   = (t.match(/\b\d{2}\/\d{2}\/\d{4}\b/)||['',''])[1] || '';

  // Phones (ignore '-' placeholders), up to two
  const phones = Array.from(t.matchAll(/\b(?:\+?44|0)\d{9,10}\b/g)).map(m=>m[0]);
  const phone1 = (phones[0]||'');
  const phone2 = (phones[1]||'');

  // Email
  const email  = (t.match(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i)||['',''])[1] || '';

  // Use the LAST URL; strip trailing punctuation
  const urls = Array.from(t.matchAll(/https?:\/\/\S+/ig)).map(m=>m[0].replace(/[).,;]+$/,''));
  const link = urls.length ? urls[urls.length-1] : '';

  return { lead, name, pc, prod, amount, offer, date, phone1, phone2, email, link };
}

function load(){
  const d = items[i];
  set('lead', d.lead); set('name', d.name); set('pc', d.pc); set('prod', d.prod);
  set('amount', d.amount); set('offer', d.offer); set('date', d.date);
  set('phone1', d.phone1); set('phone2', d.phone2); set('email', d.email); set('link', d.link);
  document.getElementById('pos').textContent = `Customer ${i+1} of ${items.length}`;
}

function set(id,v){ document.getElementById(id).value = v ?? '' }
function val(id){ return document.getElementById(id).value.trim() }

function getData(){
  return {
    lead: val('lead'), name: val('name'), pc: val('pc'), prod: val('prod'),
    amount: val('amount'), offer: val('offer'), date: val('date'),
    phone: val('phone1') || val('phone2'),
    email: val('email'), link: val('link'),
    sender: val('sender') || 'Martin Bibb',
    greeting: getGreeting(),
    smsTpl: document.getElementById('sms').value,
    subjTpl: document.getElementById('subj').value,
    bodyTpl: document.getElementById('body').value
  };
}

function fill(t,d){
  return (t ?? '')
    .replaceAll('{{lead}}', d.lead ?? '')
    .replaceAll('{{name}}', d.name ?? '')
    .replaceAll('{{pc}}', d.pc ?? '')
    .replaceAll('{{prod}}', d.prod ?? '')
    .replaceAll('{{amount}}', d.amount ?? '')
    .replaceAll('{{offer}}', d.offer ?? '')
    .replaceAll('{{date}}', d.date ?? '')
    .replaceAll('{{link}}', d.link ?? '')
    .replaceAll('{{sender}}', d.sender ?? 'Martin Bibb')
    .replaceAll('{{greeting}}', d.greeting ?? getGreeting());
}

function ensureLink(text, link, { prefix = '\n\nQuote link: ', suffix = '' } = {}){
  if(!link){ return text; }
  if(text.includes(link)){ return text; }
  return text + `${prefix}${link}${suffix}`;
}

function ensureLinkInline(text, link){
  if(!link){ return text; }
  if(text.includes(link)){ return text; }
  return text ? `${text} ${link}` : link;
}

function sendSMS(){
  const d = getData();
  const body = ensureLink(fill(d.smsTpl, d), d.link);
  const number = (d.phone || '').replace(/\s+/g,'');
  const base = number ? `sms:${encodeURIComponent(number)}` : 'sms:';
  location.href = `${base}&body=${encodeURIComponent(body)}`;
}

function sendEmail(){
  const d = getData();
  const to = d.email ? encodeURIComponent(d.email) : '';
  const subj = encodeURIComponent(ensureLinkInline(fill(d.subjTpl, d), d.link));
  const body = encodeURIComponent(ensureLink(fill(d.bodyTpl, d), d.link));
  location.href = `mailto:${to}?subject=${subj}&body=${body}`;
}

async function sendViaPushcut(){
  const d = getData();
  const payload = buildWorkEmail(d);
  if(!payload.to){ console.warn('Pushcut email not sent: missing recipient email.'); return; }
  try{
    const res = await fetch(PUSH_CUT_WEBHOOK_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      console.warn('Pushcut webhook responded with status', res.status);
    }
  }catch(e){
    console.error('Pushcut webhook failed', e);
  }
}

function buildWorkEmail(d){
  const subjectToken = d.offer || d.date || 'follow-up';
  let subject = subjectToken ? `Your boiler quote & discount (${subjectToken})` : 'Your boiler quote & discount';
  subject = ensureLinkInline(subject, d.link);
  const discountPhrase = d.amount ? `an extra ${d.amount} discount` : 'an extra discount';
  const sender = d.sender || 'Martin Bibb';
  const greeting = d.greeting || getGreeting();
  const baseBody = `${greeting} it’s ${sender} from British Gas.\n\nI recently visited to provide you with a new boiler quotation. I’m following up because the office has offered ${discountPhrase} due to spare installation capacity at the moment.\n\nIf you’ve seen the email with this discount, great — if not, please let me know and I’ll guide you through the next steps.\n\nHave a great day.\n\n${sender}\nBritish Gas Heating Adviser`;
  const body = ensureLink(baseBody, d.link);
  return { to: d.email, subject, body };
}

async function copyAll(){
  const d = getData();
  const sms = 'SMS:\n' + ensureLink(fill(d.smsTpl, d), d.link) + '\n\n';
  const emailSubject = ensureLinkInline(fill(d.subjTpl,d), d.link);
  const emailBody = ensureLink(fill(d.bodyTpl,d), d.link);
  const email = 'EMAIL SUBJECT:\n' + emailSubject + '\n\nEMAIL BODY:\n' + emailBody;
  try { await navigator.clipboard.writeText(sms + email); alert('Copied SMS + Email to clipboard.'); }
  catch { alert('Copy failed (browser security).'); }
}

function next(){ if(i < items.length-1){ i++; load(); } }
function prev(){ if(i > 0){ i--; load(); } }

// Populate Pushcut URL on load
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('pcurl').value = PUSH_CUT_WEBHOOK_URL;
});
</script>
</body>
</html>
