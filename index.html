<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QFU Messaging • v2.0</title>
<style>
  :root { --pad:14px; }
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;max-width:980px}
  h1{margin:0 0 12px}
  .card{border:1px solid #ddd;border-radius:12px;padding:var(--pad);margin:12px 0;background:#fff}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,textarea{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ccc;border-radius:10px}
  .row{display:flex;gap:12px;flex-wrap:wrap} .row>div{flex:1;min-width:240px}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  button,a.btn{border:1px solid #ccc;border-radius:999px;padding:10px 14px;text-decoration:none;cursor:pointer;background:#fff}
  .pill{font-size:12px;background:#f4f4f4;border-radius:999px;padding:4px 8px;margin-left:6px}
  #pos{opacity:.7;margin-top:8px}
  .tiny{font-size:12px;opacity:.8}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  pre.preview{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:10px;padding:12px}
  table{border-collapse:collapse;width:100%} th,td{border:1px solid #eee;padding:8px;text-align:left}
  th{background:#fafafa}
</style>
</head>
<body>
<h1>QFU Messaging <span class="pill">v2.0</span></h1>

<!-- Ingest -->
<div class="card">
  <label>Paste customer blocks (exactly as copied; trailing lines like <em>-</em>, dates, “Appointed”, <em>LO-…</em> are fine):</label>
  <textarea id="blocks" rows="10" class="mono" placeholder="5043… - Name - BHxx xxx - (C3_01_155)
£150.00
22HSP6
18/11/2025
077xx xxxxxx
+4477xx xxxxxx
email@example.com
https://… (long quote link)
-
20/07/2022
Appointed
LO-xxxxx

5043… - Next Name - … (next record)…"></textarea>
  <div class="btns">
    <button id="parseBtn" onclick="parseAll()">Parse</button>
    <button onclick="example()">Load Example</button>
  </div>
  <div class="tiny">Tip: You can paste many records at once. Parser splits by the header line: <code>LEAD - Name - POSTCODE - (Product)</code>.</div>
</div>

<!-- Pushcut/Proxy configuration -->
<div class="card">
  <strong>Pushcut / Proxy (for work email send)</strong>
  <div class="row">
    <div>
      <label>Pushcut Notification URL (optional)</label>
      <input id="pushcutUrl" placeholder="https://api.pushcut.io/.../notifications/Send%20work%20email" oninput="saveCfg()" />
      <div class="tiny">For direct GET fallback (&content=...), or if your proxy forwards to Pushcut.</div>
    </div>
    <div>
      <label>Proxy URL (recommended for CORS)</label>
      <input id="proxyUrl" placeholder="https://qfu-email.your.workers.dev/send" oninput="saveCfg()" />
      <div class="tiny">Set this to your Cloudflare Worker endpoint that <em>POSTs</em> JSON to Pushcut. If empty, we’ll try direct Pushcut GET fallback.</div>
    </div>
  </div>
</div>

<!-- Work area -->
<div id="work" class="card" style="display:none">
  <div class="row">
    <div><label>Lead ID</label><input id="lead"></div>
    <div><label>Name</label><input id="name"></div>
    <div><label>Postcode</label><input id="pc"></div>
    <div><label>Product</label><input id="prod"></div>
  </div>
  <div class="row">
    <div><label>Offer Code</label><input id="offer"></div>
    <div><label>Amount</label><input id="amount"></div>
    <div><label>Date</label><input id="date" inputmode="numeric" placeholder="DD/MM/YYYY"></div>
  </div>
  <div class="row">
    <div><label>Phone 1</label><input id="phone1" inputmode="tel"></div>
    <div><label>Phone 2</label><input id="phone2" inputmode="tel"></div>
    <div><label>Email</label><input id="email" type="email"></div>
  </div>
  <label>Quote Link</label><input id="link">

  <div class="row">
    <div>
      <label>SMS Template</label>
      <textarea id="smsTpl" rows="10" class="mono">Good morning it’s {{name}} from British Gas.

I recently came and visited you and provided you with a new boiler quotation. I’m just following up some of my quotations and I’ve noticed that the office has offered you an extra {{amount}} discount due to spare engineer installation capacity at the moment.

I just wanted to check you have seen the email with this discount attached to it. If this is something you are interested in accepting then please follow the email with the discount code {{offer}}.

If you’re interested in accepting the extra discount and haven’t seen the email, please let me know and I’ll guide you through the next stages.

Quote link: {{link}}

Have a great day.</textarea>
    </div>
    <div>
      <label>Email Subject Template</label>
      <input id="subjTpl" value="Your boiler quote & discount ({{offer}} / {{amount}})">
      <label>Email Body Template</label>
      <textarea id="bodyTpl" rows="10" class="mono">Hello {{name}},

I recently visited to provide your boiler quotation. We currently have spare engineer installation capacity, so the office has authorised an extra discount for you.

• Offer code: {{offer}} ({{amount}})
• Quote link: {{link}}
• Lead: {{lead}} • Postcode: {{pc}} • Product: {{prod}}
• Proposed date: {{date}}

If you can’t find the discount email, reply and I’ll guide you through the next steps.

Best regards,
Martin</textarea>
    </div>
  </div>

  <h3>Preview (filled)</h3>
  <div class="row">
    <div>
      <strong>SMS</strong>
      <pre id="smsPreview" class="preview"></pre>
    </div>
    <div>
      <strong>Email</strong>
      <div class="tiny">Subject</div>
      <pre id="subjPreview" class="preview"></pre>
      <div class="tiny">Body</div>
      <pre id="bodyPreview" class="preview"></pre>
    </div>
  </div>

  <div class="btns">
    <button onclick="sendSMS()">Send SMS</button>
    <button onclick="openMail()">Open Mail</button>
    <button onclick="sendViaPushcut()">Send Email via Pushcut</button>
    <button onclick="copyBoth()">Copy both messages</button>
    <button onclick="prev()">◀︎ Prev</button>
    <button onclick="next()">Next ▶︎</button>
    <button onclick="previewAll()">Batch Preview</button>
  </div>
  <div id="pos"></div>
</div>

<!-- Batch preview -->
<div id="batch" class="card" style="display:none">
  <h3>Batch Preview (all records)</h3>
  <div style="overflow:auto;max-height:420px">
    <table id="batchTable"><thead>
      <tr><th>#</th><th>Lead</th><th>Name</th><th>Email</th><th>Offer</th><th>Amount</th><th>Link</th></tr>
    </thead><tbody></tbody></table>
  </div>
</div>

<script>
// ===================== Helpers =====================
const TEMPLATE_FIELDS = ['smsTpl','subjTpl','bodyTpl'];

function _norm(s){ return (s||'').replace(/\r/g,'').replace(/\u00A0/g,' ').trim(); }
function _lines(s){ return (s||'').replace(/\r/g,'').split('\n').map(v=>v.trim()); }
function saveCfg(){
  localStorage.setItem('qfu_pushcut', document.getElementById('pushcutUrl').value.trim());
  localStorage.setItem('qfu_proxy', document.getElementById('proxyUrl').value.trim());
}
function loadCfg(){
  document.getElementById('pushcutUrl').value = localStorage.getItem('qfu_pushcut')||'';
  document.getElementById('proxyUrl').value    = localStorage.getItem('qfu_proxy')||'';
}
function saveTemplateField(id){
  const el = document.getElementById(id);
  if(!el) return;
  localStorage.setItem(`qfu_tpl_${id}`, el.value);
}
function loadTemplates(){
  TEMPLATE_FIELDS.forEach(id => {
    const stored = localStorage.getItem(`qfu_tpl_${id}`);
    if(stored !== null){
      const el = document.getElementById(id);
      if(el) el.value = stored;
    }
  });
}

// ===================== Global state =====================
let items = [], idx = 0;

// ===================== Example =====================
function example(){
  document.getElementById('blocks').value =
`50430409 - Kirsty Rolt - BH23 4LH - (C3_01_155)
£150.00
22HSP6
18/11/2025
07714869715
+447714869715
kirstyrolt@yahoo.co.uk
https://example.com/lead/aaa

-
20/07/2022
Appointed
LO-526459

50433921 - Marian Barbu - BH1 1HX - (C3_01_155)
£125.00
22WSC4
18/11/2025
07597604176
07597604176
marian.barbu33@yahoo.ro
https://example.com/lead/bbb

50413108 - Bonnie Stanley - BH24 3AS - (C3_01_155)
£90.00
22HSP6
18/11/2025
07760456266
07760456266
bonniemaestanley@googlemail.com
https://example.com/lead/ccc`;
 loadCfg();
  loadTemplates();
}

// ===================== Parsing =====================
// Split by header lines: "LEAD - Name - PC - (Product)"
function parseAll(){
  loadCfg();
  loadTemplates();
  const raw0 = document.getElementById('blocks').value || '';
  if(!_norm(raw0)){ alert('Paste one or more customer blocks first.'); return; }

  const raw = raw0.replace(/\r/g,'').replace(/\u00A0/g,' ');
  const lines = raw.split('\n');
  const headerRe = /^\s*(\d+)\s*-\s*.+?\s*-\s*[A-Z0-9 ]{3,8}\s*-\s*\([^)]+\)\s*$/i;

  const starts = [];
  for(let i=0;i<lines.length;i++){ if(headerRe.test(lines[i])) starts.push(i); }

  let blocks = [];
  if(starts.length){
    for(let j=0;j<starts.length;j++){
      const start = starts[j];
      const end = (j<starts.length-1) ? starts[j+1] : lines.length;
      const chunk = lines.slice(start,end).join('\n').trim();
      if(chunk) blocks.push(chunk);
    }
  } else {
    // fallback: blank line split
    blocks = raw.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);
    if(!blocks.length) blocks = [raw.trim()];
  }

  items = blocks.map(parseBlockSmart).filter(d => d && (d.lead || d.email || d.link));
  if(!items.length){ alert('Could not parse any valid blocks.'); return; }
  idx = 0;
  document.getElementById('work').style.display = 'block';
  loadRecord();
  buildBatchTable();
}

// Extract fields from one chunk
function parseBlockSmart(text){
  const t = _norm(text);

  // header anywhere
  let lead='', name='', pc='', prod='';
  const m1 = t.match(/(\d+)\s*-\s*(.+?)\s*-\s*([A-Z0-9 ]{3,8})\s*-\s*\(([^)]+)\)/i);
  if(m1){ lead=_norm(m1[1]); name=_norm(m1[2]); pc=_norm(m1[3]); prod=_norm(m1[4]); }

  // amount £...
  const amount = (t.match(/(£\s?\d[\d,]*\.?\d{0,2})/i)||['',''])[1] || '';

  // offer: prefer a single-token alnum 5–12 in early lines; else fallback
  const offer = findOffer(text);

  // first date dd/mm/yyyy
  const date   = (t.match(/\b\d{2}\/\d{2}\/\d{4}\b/)||['',''])[1] || '';

  // mobiles 07… / +447… (with spaces)
  const mobileRe = /\b(?:\+?\s*44\s*7\d{2}|0\s*7\d{2})\s*\d{3}\s*\d{4}\b/ig;
  const phones = Array.from(t.matchAll(mobileRe))
    .map(m=>m[0].replace(/\s+/g,'').replace(/^0/,'+44').replace(/^\+?44/,'+44'));
  const phone1 = phones[0] || '';
  const phone2 = phones[1] || '';

  // email (take the last)
  const emails = Array.from(t.matchAll(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/ig))
                      .map(m=>m[0]);
  const email = emails.length ? emails[emails.length-1].toLowerCase() : '';

  // last URL (strip trailing punct)
  const urls = Array.from(t.matchAll(/https?:\/\/\S+/ig))
                    .map(m=>m[0].replace(/[).,;]+$/,''));
  const link = urls.length ? urls[urls.length-1] : '';

  return { lead, name, pc, prod, amount, offer, date, phone1, phone2, email, link };
}

function findOffer(text){
  const L = _lines(text).filter(Boolean);
  for(let k=1; k<Math.min(L.length,12); k++){
    const m = L[k].match(/^[A-Z0-9]{5,12}$/i);
    if(m && /[A-Z]/i.test(m[0]) && /\d/.test(m[0])) return m[0].toUpperCase();
  }
  const all = text.match(/\b(?!cid=)(?!LO-)[A-Z0-9]{5,12}\b/ig) || [];
  const pick = all.find(s => /[A-Z]/i.test(s) && /\d/.test(s));
  return (pick || '').toUpperCase();
}

// ===================== UI/Preview =====================
function setVal(id,v){ document.getElementById(id).value = v ?? ''; }
function getVal(id){ return document.getElementById(id).value.trim(); }
function current(){
  return {
    lead:getVal('lead'), name:getVal('name'), pc:getVal('pc'), prod:getVal('prod'),
    amount:getVal('amount'), offer:getVal('offer'), date:getVal('date'),
    phone: getVal('phone1') || getVal('phone2'),
    email:getVal('email'), link:getVal('link')
  };
}
function fillTpl(tpl, rec){
  return (tpl||'')
    .replace(/{{\s*lead\s*}}/gi, rec.lead||'')
    .replace(/{{\s*name\s*}}/gi, rec.name||'')
    .replace(/{{\s*pc\s*}}/gi, rec.pc||'')
    .replace(/{{\s*prod\s*}}/gi, rec.prod||'')
    .replace(/{{\s*amount\s*}}/gi, rec.amount||'')
    .replace(/{{\s*offer\s*}}/gi, rec.offer||'')
    .replace(/{{\s*date\s*}}/gi, rec.date||'')
    .replace(/{{\s*link\s*}}/gi, rec.link||'')
    .replace(/{{\s*email\s*}}/gi, rec.email||'');
}
function refreshPreview(){
  const rec = current();
  const sms  = fillTpl(getVal('smsTpl'), rec);
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  document.getElementById('smsPreview').textContent  = sms;
  document.getElementById('subjPreview').textContent = subj;
  document.getElementById('bodyPreview').textContent = body;
  const pos = document.getElementById('pos');
  if(pos) pos.textContent = items.length ? `Record ${idx+1} of ${items.length}` : '';
}
function loadRecord(){
  const d = items[idx];
  setVal('lead', d.lead); setVal('name', d.name); setVal('pc', d.pc); setVal('prod', d.prod);
  setVal('amount', d.amount); setVal('offer', d.offer); setVal('date', d.date);
  setVal('phone1', d.phone1); setVal('phone2', d.phone2); setVal('email', d.email); setVal('link', d.link);
  refreshPreview();
}
function next(){ if(idx < items.length-1){ idx++; loadRecord(); } }
function prev(){ if(idx > 0){ idx--; loadRecord(); } }

function buildBatchTable(){
  const tbody = document.querySelector('#batchTable tbody');
  tbody.innerHTML = '';
  items.forEach((d, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${d.lead||''}</td><td>${d.name||''}</td><td>${d.email||''}</td><td>${d.offer||''}</td><td>${d.amount||''}</td><td>${d.link?'<a href="'+d.link+'" target="_blank">link</a>':''}</td>`;
    tbody.appendChild(tr);
  });
}
function previewAll(){
  buildBatchTable();
  document.getElementById('batch').style.display = 'block';
}

// ===================== Actions =====================
function smsURLEncode(s){ return encodeURIComponent(s); } // preserve spaces/newlines (%20/%0A)

function sendSMS(){
  const rec = current();
  const msg = fillTpl(getVal('smsTpl'), rec);
  const number = (rec.phone||'').replace(/\s+/g,'');
  const base = number ? `sms:${encodeURIComponent(number)}` : 'sms:';
  location.href = `${base}&body=${smsURLEncode(msg)}`;
}
function openMail(){
  const rec = current();
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  const to   = rec.email ? encodeURIComponent(rec.email) : '';
  location.href = `mailto:${to}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
}
async function sendViaPushcut(){
  const proxy = getVal('proxyUrl');
  const pushcut = getVal('pushcutUrl');
  const rec = current();
  const payload = {
    to: rec.email,
    subject: fillTpl(getVal('subjTpl'), rec),
    body: fillTpl(getVal('bodyTpl'), rec),
    meta: { lead:rec.lead, name:rec.name, pc:rec.pc, prod:rec.prod, offer:rec.offer, amount:rec.amount, link:rec.link, date:rec.date }
  };

  if(proxy){
    try{
      const res = await fetch(proxy, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error('Proxy failed '+res.status);
      alert('Sent to Pushcut via proxy 👍');
      return;
    }catch(e){ alert('Proxy error: '+e.message); }
  }

  if(pushcut){
    // Fallback: open Pushcut URL with JSON in the query (GET). Works from Safari; not ideal for very long bodies.
    const url = `${pushcut}${pushcut.includes('?')?'&':'?'}content=${encodeURIComponent(JSON.stringify(payload))}`;
    window.open(url, '_blank');
  } else {
    alert('Set a Proxy URL or Pushcut URL first.');
  }
}
async function copyBoth(){
  const rec = current();
  const sms  = fillTpl(getVal('smsTpl'), rec);
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  const txt = `SMS:\n${sms}\n\nEMAIL SUBJECT:\n${subj}\n\nEMAIL BODY:\n${body}`;
  try{ await navigator.clipboard.writeText(txt); alert('Copied SMS + Email to clipboard.'); }catch{ alert('Copy failed (browser)'); }
}

// Live preview when user edits fields/templates
['lead','name','pc','prod','amount','offer','date','phone1','phone2','email','link','smsTpl','subjTpl','bodyTpl']
  .forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', () => {
      if(TEMPLATE_FIELDS.includes(id)) saveTemplateField(id);
      refreshPreview();
    });
  });

// Restore saved config + templates on load
document.addEventListener('DOMContentLoaded', () => {
  loadCfg();
  loadTemplates();
  refreshPreview();
});
</script>
</body>
</html>
