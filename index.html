<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QFU Messaging ‚Ä¢ v2.5 (Tab-Separated Support)</title>
<style>
  :root {
    --pad:14px;
    --primary:#2563eb;
    --primary-hover:#1d4ed8;
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
    --gray-50:#f9fafb;
    --gray-100:#f3f4f6;
    --gray-200:#e5e7eb;
    --gray-300:#d1d5db;
    --gray-700:#374151;
    --gray-900:#111827;
  }
  html,body{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);min-height:100vh}
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:20px;max-width:1000px;margin:0 auto}
  h1{margin:0 0 20px;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.1);font-size:28px}
  .card{border:none;border-radius:16px;padding:24px;margin:16px 0;background:#fff;box-shadow:0 4px 6px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.06);transition:all 0.3s ease}
  .card:hover{box-shadow:0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05)}
  label{display:block;font-weight:600;margin:12px 0 8px;color:var(--gray-700);font-size:14px}
  input,textarea{width:100%;box-sizing:border-box;padding:12px 14px;border:2px solid var(--gray-200);border-radius:10px;background:#fff;transition:all 0.2s ease;font-size:14px}
  input:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
  input.invalid{border-color:var(--danger);background:#fef2f2}
  .row{display:flex;gap:14px;flex-wrap:wrap} .row>div{flex:1;min-width:220px}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px;align-items:center}
  .btns input{flex:1;min-width:200px}
  button{border:2px solid var(--primary);border-radius:10px;padding:12px 20px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s ease;box-shadow:0 2px 4px rgba(37,99,235,0.2)}
  button:hover{background:var(--primary-hover);border-color:var(--primary-hover);transform:translateY(-1px);box-shadow:0 4px 8px rgba(37,99,235,0.3)}
  button:active{transform:translateY(0);box-shadow:0 2px 4px rgba(37,99,235,0.2)}
  button.secondary{background:#fff;color:var(--primary);border-color:var(--gray-300)}
  button.secondary:hover{background:var(--gray-50);border-color:var(--primary)}
  button.success{background:var(--success);border-color:var(--success)}
  button.success:hover{background:#059669;border-color:#059669}
  button.danger{background:var(--danger);border-color:var(--danger)}
  button.danger:hover{background:#dc2626;border-color:#dc2626}
  .pill{font-size:13px;background:rgba(255,255,255,0.9);border-radius:999px;padding:6px 12px;margin-left:8px;font-weight:600;color:var(--primary)}
  pre.preview{white-space:pre-wrap;background:var(--gray-50);border:2px solid var(--gray-200);border-radius:12px;padding:16px;margin:8px 0;font-size:14px;line-height:1.6;transition:all 0.2s ease}
  table{border-collapse:collapse;width:100%;font-size:13px}
  th,td{border:1px solid var(--gray-200);padding:10px;text-align:left}
  th{background:var(--gray-100);font-weight:600;color:var(--gray-700)}
  td{background:#fff}
  .tiny{font-size:13px;opacity:.75;color:var(--gray-700);margin-top:8px}
  #pos{opacity:.8;margin-top:12px;font-weight:600;color:var(--gray-700)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .status{margin-top:8px;font-size:14px;font-weight:500}
  .record-done{color:var(--success);font-weight:700}
  .preview.done{border-color:var(--success);background:#f0fdf4;box-shadow:0 0 0 3px rgba(16,185,129,0.1)}
  tr.is-done td{background:#f0fdf4}
  .alert{padding:14px 18px;border-radius:10px;margin:12px 0;font-size:14px;font-weight:500}
  .alert.success{background:#f0fdf4;color:#065f46;border:2px solid var(--success)}
  .alert.error{background:#fef2f2;color:#991b1b;border:2px solid var(--danger)}
  .alert.warning{background:#fffbeb;color:#92400e;border:2px solid var(--warning)}
  .validation-msg{font-size:12px;color:var(--danger);margin-top:4px;font-weight:500}
  .batch-controls{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
  .progress-bar{background:var(--gray-200);border-radius:999px;height:8px;overflow:hidden;margin:12px 0}
  .progress-fill{background:linear-gradient(90deg, var(--primary), var(--success));height:100%;transition:width 0.3s ease}
  h3{color:var(--gray-900);margin:0 0 16px;font-size:20px}
  strong{color:var(--gray-900)}
</style>
</head>
<body>
<h1>QFU Messaging <span class="pill">v2.5</span></h1>

<div class="card">
  <label>Paste data (raw from Salesforce or the Markdown version from your Shortcut):</label>
  <textarea id="blocks" rows="14" class="mono" placeholder="[5043‚Ä¶ - Name - BHxx xxx - (C3_01_155)](‚Ä¶)
¬£150.00
22HSP6
18/11/2025
[077‚Ä¶](tel:077‚Ä¶)
[+447‚Ä¶](tel:+447‚Ä¶)
[email@‚Ä¶](mailto:email@‚Ä¶)
<https://‚Ä¶>
-
20/07/2022
Appointed
LO-xxxxx

[5043‚Ä¶ - Next Name - ‚Ä¶](‚Ä¶)"></textarea>
  <div class="btns">
    <input id="sender" placeholder="Sender (e.g. Martin Bibb)" value="Martin Bibb" aria-label="Sender name">
    <button onclick="parseAll()">üîç Parse</button>
    <button onclick="example()" class="secondary">üìã Load Example</button>
  </div>
  <div id="parseMsg" style="display:none"></div>
  <div class="tiny">Parser supports both tab-separated (from spreadsheets) and line-by-line markdown formats.</div>
</div>

<div id="templates" class="card">
  <h3>Pre-formed Messages</h3>
  <div class="row">
    <div>
      <label>SMS Template</label>
      <textarea id="smsTpl" rows="11" class="mono">Good {{time based option}} it‚Äôs {{sender}} from British Gas.

I recently visited and provided you with a boiler quotation. I‚Äôm following up as the office has offered you an extra {{amount}}
discount (code {{offer}}) due to spare engineer capacity.

Offer ends: {{offerEnds}}.

If you‚Äôve seen the email with this discount, great ‚Äî if not, let me know and I‚Äôll guide you through the next steps.

Quote link: {{link}}

Have a great day.</textarea>
    </div>
    <div>
      <label>Email Subject Template</label>
      <input id="subjTpl" value="Your boiler quote & discount ({{offer}} / {{amount}}) ‚Äì ends {{offerEnds}}">
      <label>Email Body Template</label>
      <textarea id="bodyTpl" rows="12" class="mono">Hello {{name}},

I recently visited to provide your boiler quotation for your home. We currently have spare engineer capacity, so the office has authorised an extra discount for you.

‚Ä¢ Offer code: {{offer}} ({{amount}})
‚Ä¢ Offer ends: {{offerEnds}}
‚Ä¢ Quote link: {{link}}

If you can‚Äôt find the discount email, reply and I‚Äôll guide you through the next steps.

Best regards,</textarea>
    </div>
  </div>
  <div class="tiny">Review and adjust these templates before parsing. They‚Äôll be hidden once your records are ready.</div>
</div>

<div id="work" class="card" style="display:none">
  <div class="row">
    <div><label>Lead</label><input id="lead"></div>
    <div><label>Name</label><input id="name"></div>
    <div><label>Postcode</label><input id="pc"></div>
    <div><label>Area</label><input id="area"></div>
  </div>
  <div class="row">
    <div><label>Offer Amount</label><input id="amount" placeholder="¬£150.00"></div>
    <div><label>Offer Code</label><input id="offer" placeholder="22HSP6"></div>
    <div><label>Offer Ends</label><input id="offerEnds" placeholder="DD/MM/YYYY"></div>
  </div>
  <div class="row">
    <div><label>Mobile</label><input id="phone1" inputmode="tel"></div>
    <div><label>Other Number</label><input id="phone2" inputmode="tel"></div>
    <div><label>Email</label><input id="email" type="email"></div>
  </div>
  <label>Quote Link</label><input id="link" placeholder="https://‚Ä¶">

  <div class="row">
    <div><label>HSA Followed Up</label><input id="hsa"></div>
    <div><label>Offer Created</label><input id="created" placeholder="DD/MM/YYYY"></div>
    <div><label>Stage</label><input id="stage"></div>
    <div><label>Offer Name</label><input id="offerName"></div>
  </div>


  <h3>Preview (filled)</h3>
  <div class="row">
    <div>
      <strong>SMS</strong>
      <pre id="smsPreview" class="preview"></pre>
    </div>
    <div>
      <strong>Email</strong>
      <div class="tiny">Subject</div>
      <pre id="subjPreview" class="preview"></pre>
      <div class="tiny">Body</div>
      <pre id="bodyPreview" class="preview"></pre>
    </div>
  </div>

  <div class="btns">
    <button onclick="sendSMS()">üì± Send SMS</button>
    <button onclick="openMail()">üìß Send Email</button>
    <button onclick="copyBoth()" class="secondary">üìã Copy Both</button>
    <button onclick="prev()" class="secondary">‚óÄ Prev</button>
    <button onclick="next()" class="secondary">Next ‚ñ∂</button>
    <button onclick="previewAll()" class="secondary">üìä Batch Preview</button>
  </div>
  <div id="pos"></div>
  <div id="status" class="tiny status"></div>
</div>

<div id="batch" class="card" style="display:none">
  <h3>üìä Batch Operations</h3>
  <div class="batch-controls">
    <button onclick="batchSendSMS()" class="success">üì± Send All SMS</button>
    <button onclick="batchSendEmail()" class="success">üìß Send All Emails</button>
    <button onclick="batchSendBoth()" class="success">üöÄ Send All (SMS + Email)</button>
    <button onclick="hideBatch()" class="secondary">‚úï Close</button>
  </div>
  <div id="batchProgress" style="display:none">
    <div class="progress-bar">
      <div id="progressFill" class="progress-fill" style="width:0%"></div>
    </div>
    <div id="progressText" class="tiny" style="text-align:center"></div>
  </div>
  <div id="batchResult" style="display:none"></div>
  <div style="overflow:auto;max-height:420px;margin-top:16px">
    <table id="batchTable"><thead>
      <tr>
        <th>#</th><th>Lead</th><th>Name</th><th>PC</th><th>Area</th>
        <th>¬£</th><th>Code</th><th>Ends</th><th>Email</th><th>Mobile</th><th>Link</th><th>Status</th>
      </tr>
    </thead><tbody></tbody></table>
  </div>
</div>

<script>
/* ========= Normalise & Markdown helpers ========= */
function basePre(s){
  return (s||'')
    .replace(/\r/g,'')
    .replace(/\u00A0/g,' ')
    .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g,'-');
}
function baseNorm(s){ return basePre(s).trim(); }
function baseLines(s){ return basePre(s).split('\n'); }

const emailPlainRe  = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/ig;
const urlPlainRe    = /https?:\/\/[^\s)>,]+/ig;
const mobilePlainRe = /\b(?:\+?\s*44\s*7\d{2}|0\s*7\d{2})\s*\d{3}\s*\d{4}\b/ig;

function markdownify(text){
  const lines = baseLines(text);
  const out = [];
  for(let i=0;i<lines.length;i++){
    let ln = lines[i];
    if(!HEADER_RE.test(ln)){
      ln = ln.replace(urlPlainRe, (m)=>`<${m}>`);
      ln = ln.replace(emailPlainRe, (m)=>`[${m}](mailto:${m})`);
      ln = ln.replace(mobilePlainRe, (m)=>{
        const tel = m.replace(/\s+/g,'');
        return `[${m}](tel:${tel})`;
      });
    }
    out.push(ln);
  }
  return out.join('\n');
}

function stripMarkdownLinks(s){
  return (s||'')
    // [label](mailto:‚Ä¶|tel:‚Ä¶|http‚Ä¶)
    .replace(/\[([^\]]+)\]\((?:mailto:|tel:|https?:\/\/)[^)]+\)/gi,'$1')
    // <https://‚Ä¶>
    .replace(/<\s*(https?:\/\/[^>\s]+)\s*>/gi,'$1');
}

function pre(s){ return stripMarkdownLinks(basePre(s)); }
function _norm(s){ return pre(s).trim(); }
function _lines(s){ return pre(s).split('\n'); }

/* ========= Regexes ========= */
const HEADER_RE = /^\s*(\d+)\s*[-‚Äì‚Äî]\s*(.+?)\s*[-‚Äì‚Äî]\s*([A-Z0-9 ]{3,8})\s*[-‚Äì‚Äî]\s*\(([^)]+)\)\s*$/i;
const emailRe  = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;
const moneyRe  = /(¬£\s?\d[\d,]*\.?\d{0,2})/i;
const dateRe   = /\b\d{2}\/\d{2}\/\d{4}\b/;
const urlRe    = /https?:\/\/[^\s)>,]+/i;
const mobileRe = /\b(?:\+?\s*44\s*7\d{2}|0\s*7\d{2})\s*\d{3}\s*\d{4}\b/ig;

/* ========= State ========= */
let items=[], idx=0;

/* ========= Example ========= */
function example(){
  document.getElementById('blocks').value =
`[50430409 - Kirsty Rolt - BH23 4LH - (C3_01_155)](https://homeinstallation.my.salesforce.com/006Tw00000JaxY5)
¬£150.00
22HSP6
18/11/2025
[07714869715](tel:07714869715)
[+447714869715](tel:+447714869715)
[kirstyrolt@yahoo.co.uk](mailto:kirstyrolt@yahoo.co.uk)
<https://www.mybritishgashomeinstallation.co.uk/lead/dd99df81eb34b18b18fbdf5b38341c873543528d2bc15723c608dc14f1836b413b57e40e5fbe76eb61eca122872b6613>
-
20/07/2022
Appointed
LO-526459

[50433921 - Marian Barbu - BH1 1HX - (C3_01_155)](https://homeinstallation.my.salesforce.com/006Tw00000JgzXB)
¬£150.00
22WSC4
18/11/2025
[07597604176](tel:07597604176)
[07597604176](tel:07597604176)
[marian.barbu33@yahoo.ro](mailto:marian.barbu33@yahoo.ro)
<https://www.mybritishgashomeinstallation.co.uk/lead/f470d2e598ca41d32b8a4ca0acb96b44647e8e502f69988fd4591959827e0c2998f37a6bb47fd3327863b586ca19708d?cid=oem_HSA_Web>
-
20/07/2022
Appointed
LO-527152`;
}

/* ========= Parse entry ========= */
function looksLikeHtmlInput(text){
  if(!text){ return false; }
  return /<\/(?:div|p|span|table|tbody|tr|td|th|strong|em|br)[^>]*>/i.test(text)
    || /<\s*(?:div|p|span|table|tbody|tr|td|th|strong|em|br)\b[^>]*>/i.test(text);
}

function htmlToMarkdown(text){
  const wrap = document.createElement('div');
  wrap.innerHTML = text;

  wrap.querySelectorAll('a').forEach(a => {
    const href = a.getAttribute('href') || '';
    const label = a.textContent || href;
    const md = href ? `[${label}](${href})` : label;
    a.replaceWith(document.createTextNode(md));
  });

  wrap.querySelectorAll('br').forEach(br => {
    br.replaceWith(document.createTextNode('\n'));
  });

  const blockTags = ['p','div','section','article','header','footer','li','tr'];
  blockTags.forEach(tag => {
    wrap.querySelectorAll(tag).forEach(el => {
      if(el.childNodes.length === 0){ return; }
      const last = el.childNodes[el.childNodes.length-1];
      if(last.nodeType === 3){
        if(!/\n$/.test(last.textContent || '')){
          last.textContent = `${last.textContent}\n`;
        }
      }else{
        el.appendChild(document.createTextNode('\n'));
      }
    });
  });

  const txt = wrap.textContent || '';
  return txt.replace(/\n{3,}/g,'\n\n');
}

function autoMarkdown(text){
  if(!looksLikeHtmlInput(text)){ return text; }
  try{
    return htmlToMarkdown(text);
  }catch{
    return text;
  }
}

function showParseMsg(msg, type = 'success'){
  const el = document.getElementById('parseMsg');
  if(!el) return;
  el.textContent = msg;
  el.className = `alert ${type}`;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 5000);
}

function parseAll(){
  const ta = document.getElementById('blocks');
  const raw0 = ta ? ta.value : '';
  if(!baseNorm(raw0)){
    showParseMsg('‚ö†Ô∏è Please paste data first.', 'error');
    return;
  }

  try {
    // Check if data is tab-separated first
    const normalized = basePre(raw0);
    const isTabFormat = isTabSeparated(normalized);

    let clean;
    if(isTabFormat){
      // For tab-separated data, just normalize without markdown conversion
      clean = normalized;
      if(ta) ta.value = clean;
    } else {
      // For regular format, apply markdown conversion
      const prepared = autoMarkdown(raw0);
      const md = markdownify(prepared);
      if(ta) ta.value = md;
      clean = stripMarkdownLinks(basePre(md));
    }

    items = parseBlocks(clean).map(rec => ({...rec, smsDone:false, emailDone:false}));

    if(!items.length){
      showParseMsg('‚ùå Could not parse any records. Please check the format.', 'error');
      return;
    }

    // Validate records
    let warnings = [];
    items.forEach((rec, i) => {
      if(!rec.name) warnings.push(`Record ${i+1}: Missing name`);
      if(!rec.email && !rec.phone1) warnings.push(`Record ${i+1}: Missing contact info`);
      if(!rec.amount) warnings.push(`Record ${i+1}: Missing offer amount`);
      if(!rec.offer) warnings.push(`Record ${i+1}: Missing offer code`);
    });

    idx=0;
    const templatesCard = document.getElementById('templates');
    if(templatesCard) templatesCard.style.display='none';
    document.getElementById('work').style.display='block';
    loadRecord();
    buildBatchTable();

    if(warnings.length > 0 && warnings.length <= 5) {
      showParseMsg(`‚úÖ Parsed ${items.length} record(s). Warnings: ${warnings.join('; ')}`, 'warning');
    } else if(warnings.length > 5) {
      showParseMsg(`‚úÖ Parsed ${items.length} record(s) with ${warnings.length} warnings. Check records.`, 'warning');
    } else {
      showParseMsg(`‚úÖ Successfully parsed ${items.length} record(s)!`, 'success');
    }
  } catch(err) {
    showParseMsg(`‚ùå Parse error: ${err.message}`, 'error');
  }
}

/* ========= Core parser (header split + positional fields) ========= */
function isTabSeparated(text){
  // Check if the text contains tab-separated data
  const lines = text.split('\n').filter(l => l.trim() && !l.includes('Offer Description'));
  if(lines.length === 0) return false;

  // Count tabs in first non-empty line
  const firstLine = lines[0];
  const tabCount = (firstLine.match(/\t/g) || []).length;

  // If we have 8+ tabs and the header pattern appears before first tab, it's likely tab-separated
  return tabCount >= 8 && /^\s*\d+\s*[-‚Äì‚Äî]\s*.+?\s*[-‚Äì‚Äî]\s*[A-Z0-9 ]{3,8}\s*[-‚Äì‚Äî]\s*\([^)]+\)\t/.test(firstLine);
}

function parseTabSeparatedLine(line){
  // Skip lines with "Offer Description" or empty lines
  if(!line.trim() || line.includes('Offer Description')) return null;

  const parts = line.split('\t').map(s => s.trim()).filter(s => s); // Filter out empty parts from leading tabs
  if(parts.length < 9) return null; // Need at least header + 8 fields

  // First non-empty part is the header: "50477539 - Dionne Johnson - BH23 2HS - (C3_01_155)"
  const headerStr = parts[0];
  const hm = headerStr.match(HEADER_RE);
  if(!hm) return null;

  const lead = hm[1].trim();
  const name = hm[2].trim();
  const pc = hm[3].trim();
  const area = hm[4].trim();

  // Remaining parts are the fields
  const amount = pickAmount(parts[1]);
  const offer = pickOffer(parts[2]);
  const offerEnds = pickDate(parts[3]);
  const phone1 = pickPhone(parts[4]);
  const phone2 = pickPhone(parts[5]);
  const email = pickEmail(parts[6]) || '';
  const link = pickUrl(parts[7]) || '';
  const hsa = parts[8] || '';
  const created = pickDate(parts[9]) || '';
  const stage = parts[10] || '';
  const offerName = parts[11] || '';

  return { lead, name, pc, area, amount, offer, offerEnds, phone1, phone2, email, link, hsa, created, stage, offerName };
}

function parseBlocks(text){
  // Check if data is tab-separated
  if(isTabSeparated(text)){
    const lines = text.split('\n');
    const records = lines
      .map(parseTabSeparatedLine)
      .filter(r => r !== null && validRec(r));
    return records;
  }

  // Original parsing logic for line-by-line format
  const lines = _lines(text);
  const starts=[];
  for(let i=0;i<lines.length;i++){ if(HEADER_RE.test(lines[i])) starts.push(i); }
  // fallback: blank-line blocks if no headers
  if(!starts.length){
    const chunks = text.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);
    return chunks.map(parseOne).filter(validRec);
  }
  const blocks=[];
  for(let j=0;j<starts.length;j++){
    const start=starts[j];
    const end=(j<starts.length-1)?starts[j+1]:lines.length;
    blocks.push(lines.slice(start,end).join('\n').trim());
  }
  return blocks.map(parseOne).filter(validRec);
}
function validRec(r){ return r && (r.lead || r.email || r.link); }

function getTimeBasedOption(){
  const hour = new Date().getHours();
  if(hour < 12) return 'morning';
  if(hour < 17) return 'afternoon';
  return 'evening';
}

function parseOne(block){
  const ls = _lines(block).map(s=>s.trim()).filter(Boolean);
  const hIdx = ls.findIndex(ln=>HEADER_RE.test(ln));
  if(hIdx<0) return {};

  const hm = ls[hIdx].match(HEADER_RE);
  const lead = hm[1].trim(), name = hm[2].trim(), pc = hm[3].trim(), area = hm[4].trim();

  // Next lines in order; allow blanks / '-' lines (skip them)
  const tail = ls.slice(hIdx+1).filter(x => x && x !== '-');

  // Positional mapping with validation/fallbacks
  const amount    = pickAmount(tail[0]);
  const offer     = pickOffer(tail[1]);
  const offerEnds = pickDate(tail[2]);

  const phone1    = pickPhone(tail[3]);
  const phone2    = pickPhone(tail[4]);

  const email     = pickEmail(tail[5]) || findLastEmail(tail);
  const link      = pickUrl(tail[6])   || findFirstUrl(tail);

  const hsa       = tail[7] || '';
  const created   = pickDate(tail[8]) || '';
  const stage     = tail[9] || '';
  const offerName = tail[10] || '';

  return { lead,name,pc,area, amount,offer,offerEnds, phone1,phone2, email,link, hsa,created,stage,offerName };
}

/* ========= Pickers / validators ========= */
function pickAmount(s){ const m=(s||'').match(moneyRe); return m?m[1]: (s||''); }
function pickOffer(s){
  const v=(s||'').trim().toUpperCase();
  if(/^[A-Z0-9]{5,12}$/.test(v) && /[A-Z]/.test(v) && /\d/.test(v)) return v;
  return v;
}
function pickDate(s){ const m=(s||'').match(dateRe); return m?m[0]: (s||''); }
function pickPhone(s){
  const raw=(s||'').toString().trim();
  if(!raw || raw==='-') return '';
  const m = raw.match(mobileRe);
  if(!m) return '';
  return m[0].replace(/\s+/g,'').replace(/^0/,'+44').replace(/^\+?44/,'+44');
}
function pickEmail(s){ const m=(s||'').match(emailRe); return m?m[0].toLowerCase():''; }
function pickUrl(s){ const m=(s||'').match(urlRe); return m? m[0].replace(/[).,;]+$/,'') : ''; }

function findLastEmail(arr){
  for(let i=arr.length-1;i>=0;i--){ const m=(arr[i]||'').match(emailRe); if(m) return m[0].toLowerCase(); }
  return '';
}
function findFirstUrl(arr){
  for(const ln of arr){ const m=(ln||'').match(urlRe); if(m) return m[0].replace(/[).,;]+$/,''); }
  return '';
}

/* ========= UI / Preview ========= */
function setVal(id,v){ document.getElementById(id).value = v ?? ''; }
function getVal(id){ return document.getElementById(id).value.trim(); }
function current(){
  const timeOption = getTimeBasedOption();
  return {
    lead:getVal('lead'), name:getVal('name'), pc:getVal('pc'), area:getVal('area'),
    amount:getVal('amount'), offer:getVal('offer'), offerEnds:getVal('offerEnds'),
    phone:getVal('phone1') || getVal('phone2'),
    email:getVal('email'), link:getVal('link'),
    hsa:getVal('hsa'), created:getVal('created'), stage:getVal('stage'), offerName:getVal('offerName'),
    sender:getVal('sender'), timeOption, timeBasedOption:timeOption
  };
}
function fillTpl(tpl, rec){
  return (tpl||'')
    .replace(/{{\s*lead\s*}}/gi, rec.lead||'')
    .replace(/{{\s*name\s*}}/gi, rec.name||'')
    .replace(/{{\s*pc\s*}}/gi, rec.pc||'')
    .replace(/{{\s*area\s*}}/gi, rec.area||'')
    .replace(/{{\s*amount\s*}}/gi, rec.amount||'')
    .replace(/{{\s*offer\s*}}/gi, rec.offer||'')
    .replace(/{{\s*offerEnds\s*}}/gi, rec.offerEnds||'')
    .replace(/{{\s*date\s*}}/gi, rec.created||'')
    .replace(/{{\s*link\s*}}/gi, rec.link||'')
    .replace(/{{\s*email\s*}}/gi, rec.email||'')
    .replace(/{{\s*stage\s*}}/gi, rec.stage||'')
    .replace(/{{\s*offerName\s*}}/gi, rec.offerName||'')
    .replace(/{{\s*sender\s*}}/gi, rec.sender||'')
    .replace(/{{\s*time\s*based\s*option\s*}}/gi, rec.timeOption||'')
    .replace(/{{\s*timeBasedOption\s*}}/gi, rec.timeOption||'');
}
function refreshPreview(){
  const rec = current();
  const sms  = fillTpl(getVal('smsTpl'), rec);
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  document.getElementById('smsPreview').textContent  = sms;
  document.getElementById('subjPreview').textContent = subj;
  document.getElementById('bodyPreview').textContent = body;
}

function setDoneState(id, done){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.toggle('done', !!done);
}

function applyDoneStyles(rec){
  const smsDone = !!(rec && rec.smsDone);
  const emailDone = !!(rec && rec.emailDone);
  setDoneState('smsPreview', smsDone);
  setDoneState('subjPreview', emailDone);
  setDoneState('bodyPreview', emailDone);
}

function updateMeta(){
  const posEl = document.getElementById('pos');
  const statusEl = document.getElementById('status');
  if(!posEl || !statusEl){ return; }
  if(!items.length){
    posEl.textContent='';
    statusEl.textContent='';
    posEl.classList.remove('record-done');
    applyDoneStyles({});
    return;
  }
  const rec = items[idx] || {};
  posEl.textContent = `Record ${idx+1} of ${items.length}`;
  const smsDone = !!rec.smsDone;
  const emailDone = !!rec.emailDone;
  const statusParts = [
    `SMS ${smsDone ? '‚úÖ Done' : '‚¨ú Pending'}`,
    `Email ${emailDone ? '‚úÖ Done' : '‚¨ú Pending'}`
  ];
  statusEl.textContent = `Status: ${statusParts.join(' ¬∑ ')}`;
  posEl.classList.toggle('record-done', smsDone && emailDone);
  applyDoneStyles(rec);
}

function loadRecord(){
  const d = items[idx];
  setVal('lead', d.lead); setVal('name', d.name); setVal('pc', d.pc); setVal('area', d.area);
  setVal('amount', d.amount); setVal('offer', d.offer); setVal('offerEnds', d.offerEnds);
  setVal('phone1', d.phone1 || ''); setVal('phone2', d.phone2 || '');
  setVal('email', d.email); setVal('link', d.link);
  setVal('hsa', d.hsa||''); setVal('created', d.created||''); setVal('stage', d.stage||''); setVal('offerName', d.offerName||'');
  refreshPreview();
  updateMeta();
}
function next(){ if(idx < items.length-1){ idx++; loadRecord(); } }
function prev(){ if(idx > 0){ idx--; loadRecord(); } }

function buildBatchTable(){
  const tbody = document.querySelector('#batchTable tbody');
  tbody.innerHTML = '';
  items.forEach((d, i) => {
    const tr = document.createElement('tr');
    const phone = d.phone1 || d.phone2 || '';
    const statusTxt = [
      d.smsDone ? 'SMS ‚úì' : 'SMS ‚Ä¶',
      d.emailDone ? 'Email ‚úì' : 'Email ‚Ä¶'
    ].join(' / ');
    tr.innerHTML = `<td>${i+1}</td><td>${d.lead||''}</td><td>${d.name||''}</td><td>${d.pc||''}</td><td>${d.area||''}</td>`
                    + `<td>${d.amount||''}</td><td>${d.offer||''}</td><td>${d.offerEnds||''}</td>`
                    + `<td>${d.email||''}</td><td>${phone}</td><td>${d.link?'<a href="'+d.link+'" target="_blank">link</a>':''}</td><td>${statusTxt}</td>`;
    if(d.smsDone && d.emailDone){ tr.classList.add('is-done'); }
    tbody.appendChild(tr);
  });
}

function previewAll(){ buildBatchTable(); document.getElementById('batch').style.display = 'block'; }

/* ========= Actions ========= */
function markMessageDone(prop){
  if(!items.length){ return; }
  const rec = items[idx];
  if(!rec){ return; }
  rec[prop] = true;
  updateMeta();
  buildBatchTable();
}

function sendSMS(){
  const rec = current();
  const msg = fillTpl(getVal('smsTpl'), rec);
  const number = (rec.phone||'').replace(/\s+/g,'');
  const base = number ? `sms:${encodeURIComponent(number)}` : 'sms:';
  markMessageDone('smsDone');
  location.href = `${base}&body=${encodeURIComponent(msg)}`;
}
function openMail(){
  const rec = current();
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  const to   = rec.email ? encodeURIComponent(rec.email) : '';
  markMessageDone('emailDone');
  location.href = `mailto:${to}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
}
async function copyBoth(){
  const rec = current();
  const sms  = fillTpl(getVal('smsTpl'), rec);
  const subj = fillTpl(getVal('subjTpl'), rec);
  const body = fillTpl(getVal('bodyTpl'), rec);
  const txt = `SMS:\n${sms}\n\nEMAIL SUBJECT:\n${subj}\n\nEMAIL BODY:\n${body}`;
  try{ await navigator.clipboard.writeText(txt); alert('‚úÖ Copied SMS + Email to clipboard.'); }catch{ alert('‚ùå Copy failed (browser)'); }
}

/* ========= Batch Operations ========= */
function hideBatch(){
  document.getElementById('batch').style.display = 'none';
}

function updateProgress(current, total, msg){
  const progressBar = document.getElementById('batchProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  if(!progressBar || !progressFill || !progressText) return;

  progressBar.style.display = 'block';
  const percent = total > 0 ? Math.round((current / total) * 100) : 0;
  progressFill.style.width = `${percent}%`;
  progressText.textContent = msg || `Processing ${current} of ${total}...`;
}

function showBatchResult(msg, type = 'success'){
  const el = document.getElementById('batchResult');
  if(!el) return;
  el.textContent = msg;
  el.className = `alert ${type}`;
  el.style.display = 'block';
}

async function batchSendSMS(){
  if(!items.length) return;

  const pending = items.filter(r => !r.smsDone && (r.phone1 || r.phone2));
  if(!pending.length){
    showBatchResult('‚ÑπÔ∏è All SMS messages already sent or no phone numbers available.', 'warning');
    return;
  }

  if(!confirm(`Send SMS to ${pending.length} contact(s)? This will open your SMS app for each message.`)) return;

  updateProgress(0, pending.length, 'Starting batch SMS...');

  let sent = 0;
  for(let i = 0; i < pending.length; i++){
    const rec = pending[i];
    const recordIdx = items.indexOf(rec);

    // Load this record
    idx = recordIdx;
    loadRecord();

    updateProgress(i + 1, pending.length, `Sending SMS ${i + 1} of ${pending.length}...`);

    // Send SMS
    const recData = {
      ...rec,
      sender: getVal('sender'),
      timeOption: getTimeBasedOption(),
      timeBasedOption: getTimeBasedOption(),
      phone: rec.phone1 || rec.phone2
    };
    const msg = fillTpl(getVal('smsTpl'), recData);
    const number = (recData.phone||'').replace(/\s+/g,'');

    if(number){
      rec.smsDone = true;
      sent++;
      // Small delay between messages
      await new Promise(resolve => setTimeout(resolve, 300));
      const base = `sms:${encodeURIComponent(number)}`;
      window.open(`${base}&body=${encodeURIComponent(msg)}`, '_blank');
    }
  }

  updateProgress(sent, pending.length, `‚úÖ Sent ${sent} SMS message(s)!`);
  showBatchResult(`‚úÖ Batch SMS complete! Sent ${sent} message(s).`, 'success');
  buildBatchTable();
  loadRecord();
}

async function batchSendEmail(){
  if(!items.length) return;

  const pending = items.filter(r => !r.emailDone && r.email);
  if(!pending.length){
    showBatchResult('‚ÑπÔ∏è All emails already sent or no email addresses available.', 'warning');
    return;
  }

  if(!confirm(`Send emails to ${pending.length} contact(s)? This will open your email client for each message.`)) return;

  updateProgress(0, pending.length, 'Starting batch email...');

  let sent = 0;
  for(let i = 0; i < pending.length; i++){
    const rec = pending[i];
    const recordIdx = items.indexOf(rec);

    // Load this record
    idx = recordIdx;
    loadRecord();

    updateProgress(i + 1, pending.length, `Sending email ${i + 1} of ${pending.length}...`);

    // Send email
    const recData = {
      ...rec,
      sender: getVal('sender'),
      timeOption: getTimeBasedOption(),
      timeBasedOption: getTimeBasedOption(),
      phone: rec.phone1 || rec.phone2
    };
    const subj = fillTpl(getVal('subjTpl'), recData);
    const body = fillTpl(getVal('bodyTpl'), recData);
    const to = recData.email ? encodeURIComponent(recData.email) : '';

    if(to){
      rec.emailDone = true;
      sent++;
      // Small delay between messages
      await new Promise(resolve => setTimeout(resolve, 300));
      window.open(`mailto:${to}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`, '_blank');
    }
  }

  updateProgress(sent, pending.length, `‚úÖ Sent ${sent} email(s)!`);
  showBatchResult(`‚úÖ Batch email complete! Sent ${sent} message(s).`, 'success');
  buildBatchTable();
  loadRecord();
}

async function batchSendBoth(){
  if(!items.length) return;

  const pendingSMS = items.filter(r => !r.smsDone && (r.phone1 || r.phone2));
  const pendingEmail = items.filter(r => !r.emailDone && r.email);
  const total = pendingSMS.length + pendingEmail.length;

  if(!total){
    showBatchResult('‚ÑπÔ∏è All messages already sent.', 'warning');
    return;
  }

  if(!confirm(`Send ${pendingSMS.length} SMS and ${pendingEmail.length} email(s)? This will open your messaging apps.`)) return;

  let processed = 0;

  // Send SMS first
  if(pendingSMS.length > 0){
    updateProgress(0, total, 'Sending SMS messages...');

    for(let i = 0; i < pendingSMS.length; i++){
      const rec = pendingSMS[i];
      const recordIdx = items.indexOf(rec);
      idx = recordIdx;
      loadRecord();

      const recData = {
        ...rec,
        sender: getVal('sender'),
        timeOption: getTimeBasedOption(),
        timeBasedOption: getTimeBasedOption(),
        phone: rec.phone1 || rec.phone2
      };
      const msg = fillTpl(getVal('smsTpl'), recData);
      const number = (recData.phone||'').replace(/\s+/g,'');

      if(number){
        rec.smsDone = true;
        processed++;
        await new Promise(resolve => setTimeout(resolve, 300));
        const base = `sms:${encodeURIComponent(number)}`;
        window.open(`${base}&body=${encodeURIComponent(msg)}`, '_blank');
      }

      updateProgress(processed, total, `Progress: ${processed} of ${total}...`);
    }
  }

  // Then send emails
  if(pendingEmail.length > 0){
    updateProgress(processed, total, 'Sending emails...');

    for(let i = 0; i < pendingEmail.length; i++){
      const rec = pendingEmail[i];
      const recordIdx = items.indexOf(rec);
      idx = recordIdx;
      loadRecord();

      const recData = {
        ...rec,
        sender: getVal('sender'),
        timeOption: getTimeBasedOption(),
        timeBasedOption: getTimeBasedOption(),
        phone: rec.phone1 || rec.phone2
      };
      const subj = fillTpl(getVal('subjTpl'), recData);
      const body = fillTpl(getVal('bodyTpl'), recData);
      const to = recData.email ? encodeURIComponent(recData.email) : '';

      if(to){
        rec.emailDone = true;
        processed++;
        await new Promise(resolve => setTimeout(resolve, 300));
        window.open(`mailto:${to}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`, '_blank');
      }

      updateProgress(processed, total, `Progress: ${processed} of ${total}...`);
    }
  }

  updateProgress(processed, total, `‚úÖ Complete! Sent ${processed} message(s)!`);
  showBatchResult(`‚úÖ Batch send complete! Sent ${pendingSMS.length} SMS and ${pendingEmail.length} email(s).`, 'success');
  buildBatchTable();
  loadRecord();
}

/* Live preview on edit */
['lead','name','pc','area','amount','offer','offerEnds','phone1','phone2','email','link','hsa','created','stage','offerName','smsTpl','subjTpl','bodyTpl','sender']
  .forEach(id => document.getElementById(id).addEventListener('input', refreshPreview));
</script>
</body>
</html>
